{{/* Build a map with all accessibility score for using it later in code :: maybe for catching progression or regression */}}
{{ $scorekey      := sha1 (string now) }}
{{ $data          := newScratch }}
{{ $time          := now.UnixMilli }}
{{ $timepartial   := now.UnixMilli }}
{{ $reflist       := (slice "accessibility" "ecoconception" "opquast" "publishing") }}
{{- if (eq (getenv "HUGO_ENV") "debugperf") -}}
  {{ $data.Set "debugperf" slice }}
{{- end -}}

{{- $data.Delete "allscores" -}}
{{- $data.Set "aggregate-accessibility-list" slice }}
{{- $data.Set "aggregate-accessibility-nc" slice }}
{{- $data.Set "aggregate-accessibility-c" slice }}
{{- $data.Set "aggregate-accessibility-sum" 0 }}
{{- $data.Set "aggregate-ecoconception-list" slice }}
{{- $data.Set "aggregate-ecoconception-nc" slice }}
{{- $data.Set "aggregate-ecoconception-c" slice }}
{{- $data.Set "aggregate-ecoconception-sum" 0 }}
{{- $data.Set "aggregate-opquast-list" slice }}
{{- $data.Set "aggregate-opquast-nc" slice }}
{{- $data.Set "aggregate-opquast-c" slice }}
{{- $data.Set "aggregate-opquast-sum" 0 }}
{{- $data.Set "aggregate-publishing-list" slice }}
{{- $data.Set "aggregate-publishing-nc" slice }}
{{- $data.Set "aggregate-publishing-c" slice }}
{{- $data.Set "aggregate-publishing-sum" 0 }}
{{- $data.Set "aggregate-performance-list" slice }}
{{- $data.Set "aggregate-performance-sum" 0 }}
{{- range sort .pages ".Title" "desc" -}}
  {{- $project := partialCached "render/projectpath" . . -}}
  {{- if ne $project "" -}}
  {{- $context := . -}}
  {{- $path := "" }}{{ with .File }}{{ $path = .Path }}{{ end }}
  {{- if and (in (path.Base $path) "index.md") (not (in "audits/_index.md" $path)) (ne (len (split $path "/")) 4) -}}

    {{ range $reflist }}
      {{ $type    := . }}
      {{ with (index (partialCached "render/lastfile.html" (dict "context" . "project" $project "type" $type) $project .) "auditfile-all-path") }}
        {{- range $id, $value := last 1 (sort .) -}}
          {{- $render := (partialCached (printf "render/%s.html" $type) (dict "context" "aggregetesscores" "auditfile" . ) .) }}
          {{- $data.SetInMap $project $type $render -}}

          {{/* Count the sum for each criteria for each value */}}
          {{ range $id, $value := $render.criteria.conforme }}

            {{- $data.Add (printf "%s%s-c" $id $type) 1 -}}
            {{- $data.SetInMap (printf "average-%s-conforme" $type) (string $id) ($data.Get (printf "%s%s-c" $id $type)) -}}

          {{ end }}
          {{ range $id, $value := $render.criteria.nonconforme }}
            {{- $data.Add (printf "%s%s-nc" $id $type) 1 -}}
            {{- $data.SetInMap (printf "average-%s-nonconforme" $type) (string $id) ($data.Get (printf "%s%s-nc" $id $type)) -}}
          {{ end }}
          {{ range $id, $value := $render.criteria.nonapplicable }}
            {{- $data.Add (printf "%s%s-na" $id $type) 1 -}}
            {{- $data.SetInMap (printf "average-%s-nonapplicable" $type) (string $id) ($data.Get (printf "%s%s-na" $id $type)) -}}
          {{ end }}

          {{- $score := $render.scores.compliance }}

          {{- $data.Add (printf "aggregate-%s-list" $type) $score -}}
          {{- $data.Add (printf "aggregate-%s-sum" $type) $score -}}
          {{- if lt $score 50 -}}
            {{- $data.Add (printf "aggregate-%s-nc" $type) $score -}}
          {{- end -}}
          {{- if eq $score 100 -}}
            {{- $data.Add (printf "aggregate-%s-c" $type) $score -}}
          {{- end -}}
        {{- end -}}
      {{ end }}
  {{ end }}

    {{- with (index (partialCached "render/lastfile.html" (dict "context" . "project" $project "type" "performance") $project "performance") "auditfile-all-path") }}
    {{- range $id, $value := last 1 (sort .) -}}
      {{- $render := (partialCached "render/performance.html" (dict "context" "aggregetesscores" "auditfile" . ) .) -}}
      {{- $data.SetInMap $project "performance" $render -}}
      {{ $score := $render.ecoscore }}
      {{- $data.Add "aggregate-performance-list" $score -}}
      {{- $data.Add "aggregate-performance-sum" $score -}}
    {{- end -}}
    {{- end -}}

    {{- if (eq (getenv "HUGO_ENV") "debugperf") -}}
      {{ $data.Add "debugperf" (printf "%s %s [%sms]" $project (.File.Path) (string (sub now.UnixMilli $timepartial))) }}
      {{ $timepartial   = now.UnixMilli }}
    {{- end -}}

  {{- end -}}
  {{- $data.SetInMap "allscores" $project           ($data.Get $project) -}}
  {{- end -}}
{{- end -}}

{{ range $reflist }}
  {{ $type := . }}
  {{- $data.SetInMap (printf "aggregate%s" .) "all"                ($data.Get (printf "aggregate-%s-list" .)) -}}
  {{- $data.SetInMap (printf "aggregate%s" .) "invalid"            ($data.Get (printf "aggregate-%s-nc" .)) -}}
  {{- $data.SetInMap (printf "aggregate%s" .) "valid"              ($data.Get (printf "aggregate-%s-c" .)) -}}
  {{- $data.SetInMap (printf "aggregate%s" .) "sum"                ($data.Get (printf "aggregate-%s-sum" .)) -}}
  {{- $data.SetInMap (printf "aggregate%s" .) "average"            slice -}}
  {{ with ($data.Get (printf "aggregate-%s-list" .)) }}
    {{- $data.SetInMap (printf "aggregate%s" $type) "average"          (div ($data.Get (printf "aggregate-%s-sum" $type)) (len .)) -}}
  {{ end }}
  {{ if and ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonconforme" $type)) }}

    {{- $data.SetInMap "average" $type   (dict
        "conforme"            ($data.Get (printf "average-%s-conforme" $type))
        "nonconforme"         ($data.Get (printf "average-%s-nonconforme" $type))
        "nonapplicable"       ($data.Get (printf "average-%s-nonapplicable" $type))
        "all"                 (merge (merge ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonconforme" $type))) ($data.Get (printf "average-%s-nonapplicable" $type)))
      )
    -}}
  {{ end }}
{{ end }}

{{- $data.SetInMap "aggregateperformance" "all"                  ($data.Get "aggregate-performance-list") -}}
{{- $data.SetInMap "aggregateperformance" "sum"                  ($data.Get "aggregate-performance-sum") -}}
{{- $data.SetInMap "aggregateperformance" "average"              slice -}}
{{ with ($data.Get "aggregate-performance-list") }}
  {{- $data.SetInMap "aggregateperformance" "average"            (div ($data.Get "aggregate-performance-sum") (len ($data.Get "aggregate-performance-list"))) -}}
{{ end }}

{{- $data.SetInMap "aggregates" "accessibility"                  ($data.Get "aggregateaccessibility") -}}
{{- $data.SetInMap "aggregates" "ecoconception"                  ($data.Get "aggregateecoconception") -}}
{{- $data.SetInMap "aggregates" "opquast"                        ($data.Get "aggregateopquast") -}}
{{- $data.SetInMap "aggregates" "publishing"                     ($data.Get "aggregatepublishing") -}}
{{- $data.SetInMap "aggregates" "performance"                    ($data.Get "aggregateperformance") -}}
{{- $data.SetInMap "aggregates" "allscores"                      ($data.Get "allscores") -}}
{{- $data.SetInMap "aggregates" "allaverage"                     ($data.Get "average") -}}

{{ return ($data.Get "aggregates") }}

{{ if (eq (getenv "HUGO_ENV") "debugperf") }}
  {{ range ($data.Get "debugperf") }}
    {{ warnf "=> Aggregates     Total[%sms] %s" (string (sub now.UnixMilli $time)) . }}
  {{ end }}
{{ end }}
